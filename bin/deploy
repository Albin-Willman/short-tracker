#!/usr/bin/env ruby

require 'aws-sdk'

bucket_name = 'kortapositioner.se'

s3 = Aws::S3::Resource.new(region:'eu-west-1')

bucket = s3.bucket(bucket_name)

dist_path = File.join(File.dirname(__FILE__), "../dist/")

def content_type(file_path)
  return 'applicaton/json' if file_path.end_with?('.json')
  return 'applicaton/x-javascript' if file_path.end_with?('.js')
  return 'text/html' if file_path.end_with?('.html')
end

def upload_file(bucket, file_path)
  bucket.object(file_path).upload_file(file_path, {content_type: content_type(file_path)})
end

if ARGV.include?('--full') || ARGV.include?('--app-only')
  root_path = File.join(File.dirname(__FILE__), "../")
  Dir.chdir root_path do
    `npm run build`
  end
  Dir.chdir dist_path do
    Dir.glob("*.*").each do |dist_file|
      upload_file(bucket, dist_file)
    end
  end
end

unless ARGV.include?('--app-only')
  Dir.chdir dist_path do
    Dir.glob("api/**/*.*").each do |dist_file|
      upload_file(bucket, dist_file)
    end
  end
end
